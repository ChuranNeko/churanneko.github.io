---
import { Icon } from "astro-icon/components";
import WidgetLayout from "@/components/common/WidgetLayout.astro";
import { siteConfig } from "@/config";
import I18nKey from "@/i18n/i18nKey";
import { i18n } from "@/i18n/translation";
import {
	getCategoryList,
	getSortedPosts,
	getTagList,
} from "@/utils/content-utils";

interface Props {
	class?: string;
	style?: string;
}

const { class: className, style } = Astro.props;

// 从配置中获取站点开始日期
const siteStartDate = siteConfig.siteStartDate || "2025-01-01";

// 获取所有文章
const posts = await getSortedPosts();
const categories = await getCategoryList();
const tags = await getTagList();

// 计算总字数
let totalWords = 0;
for (const post of posts) {
	if (post.body) {
		// 移除代码块和内联代码后计算字数
		let text = post.body
			.replace(/```[\s\S]*?```/g, "") // 移除代码块
			.replace(/`[^`]*`/g, "") // 移除内联代码
			.replace(/\s+/g, " ") // 合并空白
			.trim();

		// 分别计算中文字符和英文字符
		const chineseChars = text.match(/[\u4e00-\u9fa5]/g) || [];
		const englishChars = text.match(/[a-zA-Z]/g) || [];

		totalWords += chineseChars.length + englishChars.length;
	}
}

// 格式化数字（添加千位分隔符）
function formatNumber(num: number): string {
	return num.toLocaleString();
}

// 获取最新文章日期（用于客户端计算）
const latestPost = posts.reduce((latest, post) => {
	if (!latest) return post;
	return post.data.published > latest.data.published ? post : latest;
}, posts[0]);

const lastPostDate = latestPost
	? latestPost.data.published.toISOString()
	: null;

const todayText = i18n(I18nKey.today);

const stats = [
	{
		icon: "material-symbols:article-outline",
		label: i18n(I18nKey.siteStatsPostCount),
		value: posts.length,
	},
	{
		icon: "material-symbols:folder-outline",
		label: i18n(I18nKey.siteStatsCategoryCount),
		value: categories.length,
	},
	{
		icon: "material-symbols:label-outline",
		label: i18n(I18nKey.siteStatsTagCount),
		value: tags.length,
	},
	{
		icon: "material-symbols:text-ad-outline-rounded",
		label: i18n(I18nKey.siteStatsTotalWords),
		value: totalWords,
		formatted: true,
	},
	{
		icon: "material-symbols:calendar-clock-outline",
		label: i18n(I18nKey.siteStatsRunningDays),
		value: 0, // 将由客户端更新
		suffix: i18n(I18nKey.siteStatsDays).replace("{days}", ""),
		dynamic: true,
		id: "running-days",
	},
	{
		icon: "material-symbols:ecg-heart-outline",
		label: i18n(I18nKey.siteStatsLastUpdate),
		value: 0, // 将由客户端更新
		suffix: i18n(I18nKey.siteStatsDaysAgo).replace("{days}", ""),
		dynamic: true,
		id: "last-update",
	},
	// Umami 全站统计（如果启用）
	...(siteConfig.umami?.enable
		? [
				{
					icon: "material-symbols:visibility-outline",
					label: "全站访问",
					value: 0, // 将由客户端更新
					suffix: "",
					dynamic: true,
					id: "umami-stats",
				},
		  ]
		: []),
];
---

<WidgetLayout name={i18n(I18nKey.siteStats)} id="site-stats" class={className} style={style}>
  <div class="flex flex-col gap-2">
    {stats.map((stat) => (
      <div class="flex items-center justify-between px-3 py-1.5">
        <div class="flex items-center gap-2.5">
          <div class="text-(--primary) text-xl">
            <Icon name={stat.icon} />
          </div>
          <span class="text-neutral-700 dark:text-neutral-300 font-medium text-sm">
            {stat.label}
          </span>
        </div>
        <div class="flex items-center">
          <span 
            class="text-base font-bold text-neutral-900 dark:text-neutral-100"
            data-stat-id={stat.id}
          >
            {stat.formatted ? formatNumber(stat.value) : stat.value}
          </span>
          {stat.suffix && (
            <span class="text-sm text-neutral-500 dark:text-neutral-400 ml-1">
              {stat.suffix}
            </span>
          )}
        </div>
      </div>
    ))}
  </div>
</WidgetLayout>

<script is:inline define:vars={{ siteStartDate, lastPostDate, todayText }}>
  function updateDynamicStats() {
    const today = new Date();

    // 更新运行天数
    const startDate = new Date(siteStartDate);
    const diffTime = Math.abs(today.getTime() - startDate.getTime());
    const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));

    const runningDaysElements = document.querySelectorAll('[data-stat-id="running-days"]');
    runningDaysElements.forEach((element) => {
      element.textContent = diffDays.toString();
    });

    // 更新最后活动时间
    if (lastPostDate) {
      const lastPost = new Date(lastPostDate);
      const timeSinceLastPost = Math.abs(today.getTime() - lastPost.getTime());
      const daysSinceLastUpdate = Math.floor(timeSinceLastPost / (1000 * 60 * 60 * 24));

      const lastUpdateElements = document.querySelectorAll('[data-stat-id="last-update"]');
      lastUpdateElements.forEach((element) => {
        if (daysSinceLastUpdate === 0) {
          element.textContent = todayText;
          if (element.nextElementSibling) {
            element.nextElementSibling.style.display = 'none';
          }
        } else {
          element.textContent = daysSinceLastUpdate.toString();
          if (element.nextElementSibling) {
            element.nextElementSibling.style.display = '';
          }
        }
      });
    }
  }

  // 页面加载时更新
  updateDynamicStats();

  // 页面切换时重新更新
  document.addEventListener("swup:contentReplaced", () => {
    setTimeout(updateDynamicStats, 100);
  });
</script>

<!-- Umami 统计加载 -->
{siteConfig.umami?.enable && (
<>
  <script is:inline type="module" src="/js/umami-share.js"></script>
  
  <script define:vars={{ umamiConfig: siteConfig.umami, unavailableText: siteConfig.stats?.unavailableText, viewsText: siteConfig.stats?.viewsText, visitsText: siteConfig.stats?.visitsText }}>
      // 客户端统计文案生成函数
      function generateUmamiStatsText(pageViews, visits) {
          return `${pageViews.toLocaleString()} · ${visitsText} ${visits.toLocaleString()}`;
      }
      
      async function loadUmamiStats() {
          if (!umamiConfig.enable) {
              return;
          }
          
          try {
              // 调用全局工具获取 Umami 分享数据
              const { websiteId, token } = await getUmamiShareData(umamiConfig.baseUrl, umamiConfig.shareId);
              
              // 第二步：获取全站统计数据
              const currentTimestamp = Date.now();
              const statsUrl = `${umamiConfig.baseUrl}/analytics/us/api/websites/${websiteId}/stats?startAt=0&endAt=${currentTimestamp}&unit=hour&timezone=${encodeURIComponent(umamiConfig.timezone)}&compare=false`;
              
              const statsResponse = await fetch(statsUrl, {
                   headers: {
                       'x-umami-share-token': token
                   }
               });
              
              if (statsResponse.status === 401) {
                  clearUmamiShareCache();
                  return await loadUmamiStats();
              }
              
              if (!statsResponse.ok) {
                  throw new Error('获取统计数据失败');
              }
              
              const statsData = await statsResponse.json();
              const pageviews = statsData.pageviews || 0;
              const visitors = statsData.visitors || 0;
              
              const statsElement = document.querySelector('[data-stat-id="umami-stats"]');
              if (statsElement) {
                  statsElement.textContent = generateUmamiStatsText(pageviews, visitors);
              }
          } catch (error) {
              console.error('获取全站统计失败:', error);
              const statsElement = document.querySelector('[data-stat-id="umami-stats"]');
              if (statsElement) {
                  statsElement.textContent = unavailableText || "统计不可用";
              }
          }
      }
  
      // 页面加载完成后获取统计数据
      document.addEventListener('DOMContentLoaded', loadUmamiStats);
  </script>
</>
)}
